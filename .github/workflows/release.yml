name: Release and Publish

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.0.1)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Validate NPM Token
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "Error: NPM_TOKEN secret is not set"
            exit 1
          fi

          # Verify token is valid by checking npm whoami
          if ! curl -s -H "Authorization: Bearer ${{ secrets.NPM_TOKEN }}" \
               https://registry.npmjs.org/-/whoami 2>&1 | grep -q username; then
            echo "Error: NPM_TOKEN is invalid or expired"
            exit 1
          fi

          echo "NPM_TOKEN is valid"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate chain constants
        run: bun run generate

      - name: Check for uncommitted changes
        run: |
          if ! git diff --quiet; then
            echo "Error: Generated files have uncommitted changes"
            echo "The following files were modified during generation:"
            git diff --name-only
            echo ""
            echo "Please commit these changes before creating a release"
            exit 1
          fi
          echo "No uncommitted changes detected"

      - name: Run tests
        run: bun test

      - name: Update version in package.json
        run: |
          bun --eval "const pkg = require('./package.json'); pkg.version = '${{ inputs.version }}'; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n')"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "ðŸ”– release: v${{ inputs.version }}"
          git push

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "v${{ inputs.version }}" \
            --title "v${{ inputs.version }}" \
            --notes "## Release v${{ inputs.version }}

          Published to npm: https://www.npmjs.com/package/chains/v/${{ inputs.version }}

          ### Installation

          \`\`\`bash
          bun add chains@${{ inputs.version }}
          \`\`\`

          ### What's Changed

          See the [commit history](https://github.com/${{ github.repository }}/commits/v${{ inputs.version }}) for details.

          ðŸ¤– Generated with [GitHub Actions](https://github.com/${{ github.repository }}/actions)"

      - name: Publish to npm
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          bun publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
